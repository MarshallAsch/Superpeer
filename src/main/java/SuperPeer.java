/*
 * This Java source file was generated by the Gradle 'init' task.
 */
import ether.Settings;
import ether.TransactionsManager;

import io.left.rightmesh.id.MeshID;
import io.left.rightmesh.mesh.JavaMeshManager;
import io.left.rightmesh.mesh.MeshManager;
import io.left.rightmesh.mesh.MeshStateListener;
import io.left.rightmesh.util.MeshUtility;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

import static io.left.rightmesh.mesh.MeshManager.TRANSACTION_RECEIVED;


public class SuperPeer {

    //TODO: Add logger instead of system.out
    public static final String TAG = SuperPeer.class.getCanonicalName();

    private static final String EXIT_CMD = "exit";
    private static final String CLOSE_CHANNEL_CMD = "close";


    JavaMeshManager mm;
    private boolean isRunning = true;
    private TransactionsManager tm;

    public static void main(String[] args) {
        SuperPeer p = new SuperPeer();
    }

    public SuperPeer() {
        mm = new JavaMeshManager(true);
        System.out.println("Superpeer MeshID: " + mm.getUuid());

        //mm.on(TRANSACTION_RECEIVED, this::handleTransactionPacket);

        System.out.println("Waiting for lib to be ready");
        try {
            Thread.sleep(200);
        } catch (InterruptedException e) {
        }

        tm = TransactionsManager.getInstance(mm);
        tm.start();

        System.out.println("SuperPeer ID: " + mm.getUuid());

        //mm.sendDataReliable(mm.getUuid(), MeshUtility.TRANSACTION_PORT, "hello".getBytes());

        String msg;
        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));

        do {
            try {
                msg = br.readLine();
                processInput(msg);
            } catch (IOException e) {
                e.printStackTrace();
                break;
            }
        } while (isRunning);

        tm.stop();
        mm.stop();
    }

    private void handleTransactionPacket(MeshManager.RightMeshEvent rmEvent) {
        if (Settings.DEBUG_INFO) {
            System.out.println("Transaction received.");
        }

        MeshManager.MeshTransactionEvent event = (MeshManager.MeshTransactionEvent) rmEvent;
    }

    private void processInput(String msg) {
        if(msg.equals(EXIT_CMD)) {
            isRunning = false;
            return;
        }

        String[] args = msg.split(" ");
        if(args.length == 0) {
            return;
        }

        switch (args[0]) {
            case CLOSE_CHANNEL_CMD:
                processCloseCmd(args);
                break;

            default:
                System.out.println("Invalid command.");
                break;
        }
    }

    private void processCloseCmd(String[] args) {
        if(args.length != 2) {
            System.out.println("Invalid args.");
            return;
        }

        tm.closeChannels(args[1]);
    }
}
